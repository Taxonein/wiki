---
title: Кастомный образ windows
description: 
published: true
date: 2024-10-02T10:56:19.656Z
tags: 
editor: markdown
dateCreated: 2024-09-22T18:23:45.875Z
---

# Кастомный образ windows
## Добавление драйверов в образ

Скачиваем драйвера (в папку) с помощью Snappy, распаковываем все архивы.

Распаковываем образ windows в папку, пишем:
```
Dism /Get-ImageInfo /imagefile:"D:\ChangedISO\WinFolder\sources\install.esd"
```

Вывод даст нам информацию о имеющихся в образе версий windows. Нам нужна Windows 10 Pro.

```
Индекс: 4
Имя : Windows 10 Pro
Описание : Windows 10 Pro
Размер: 15 571 487 266 байт
```

Дополнительно, нам необходимо из .esd файла получить .wim файл. Делаем это командой:

```
dism /export-image /SourceImageFile:D:\ChangedISO\WinFolder\sources\install.esd /SourceIndex:4 /DestinationImageFile:D:\ChangedISO\WinFolder\sources\install.wim /Compress:max /CheckIntegrity
```

В папке с образом винды мы получим .wim файл. Его будем редактировать.

Монтируем образ в папку следующей командой:

```
dism /mount-wim /wimfile:"D:\ChangedISO\WinFolder\sources\install.wim" /index:1 /mountdir:D:\ChangedISO\mount
```

Далее добавляем необходимые нам драйвера в образ командой:

```
dism /image:D:\ChangedISO\mount /Add-Driver /driver:D:\ChangedISO\Drivers\ /recurse
```

После завершения операции, необходимо отключить образ (ОБЯЗАТЕЛЬНО ВЫЙТИ ИЗ ПАПКИ, ИНАЧЕ ОШИБКА):
```
dism /unmount-wim /mountdir:D:\ChangedISO\mount /commit
```

## Запаковка образа в iso

Скачиваем Windows ADK, и при установке ставим галку у "Deployment tools". После установки открываем Deployment tools. В него вбиваем следующее:

```
oscdimg.exe -m -u1 -bD:\ChangedISO\WinFolder\boot\etfsboot.com D:\ChangedISO\WinFolder D:\ChangedISO\WindowsCustom.iso
```
После чего мы получим iso образ. Далее с ним можем приступать к установке программ и других необходимых компонентов.

## Установка программ в образ

Для данного этапа нам необходим iso файл, и установленный на ПК VirtualBox. Дополнительно нам необходим USB накопитель, емкость которого будет превышать образ установочного образа (iso) windows минимум в 2 раза. Рекомендую для удобства использовать адаптер для внешнего SSD.

Открываем VirtualBox, Создаем ВМ, отключаем автоматическую установку. В настройках сети отключаем ее. Делается это для того чтобы не загрузить обновления и компоненты windows из сети.

Запускаем VM, а после устанавливаем. Ждем пока установка завершится, а пк перезагрузится. Когда система (не установленная до конца) загрузится (Плашка "Давайте начнем с региона. Это правильно?", жмем сочетание клавиш ```CTRL+SHIFT+F3```. После этого система загрузится в режиме SysPrep. Тут мы можем устанавливать программы. Однако стоит заметить то, что настройки windows которые мы тут сделаем- не войдут в конечный образ.

Детали для правильного использования SysPrep:

Для прокидывания файлов на машину используйте USB устройство. Подключается оно во вкладке VirtualBox ```Устройства->USB```.

Когда мы поставили программу, ее ярлык ОБЯЗАТЕЛЬНО нужно закинуть по пути ```C:\Users\Default\Desktop```. Делается это для того, чтобы ярлыки закинулись на учетку пользователя после установки.

Если в окне SysPrep нам необходим интернет- включите. Ничего страшного не произойдет. Просто отключите его после установки всего необходимого.

В окне SysPrep выбираем "Переход в окно приветствия системы", и ставим галку на "Подготовка к использованию". Перезагрузка.

## Запаковка образа

Когда мы закончили установку необходимого ПО, нам необходимо запаковать образ обратно в ISO. Делается это следующим образом:

1. Выключить VM
2. Подключить iso образ чистой винды, чтобы при загрузке VM у нас писало "press any key to boot from CD/DVD". Жмем любую клавишу, и попадаем в установщик Windows.
3. Жмем сочетание клавиш ```SHIFT+F10```. Откроется консоль. Далее сложнее.
4. Пишем ```diskpart```, после ```lis vol```. У нас отобразятся тома дисков.
5. При создании виртуалки мы выбирали место (50гб). Такой диск в нашем случае будет помечен желтым на скрине (49гб по той причине, что 1гб занят другими разделами, не обращаем внимание).
6. Еще нам необходим накопитель, на который мы сохраним образ. Его мы пометим синим цветом на скрине.
![windowscustom.png](/windowscustom.png)
7. Выходим из утилиты командой ```exit```.
8. Прописываем команду:
```
dism /capture-Image /imageFile:<НА КАКОЙ КОПИРОВАТЬ>:\install.wim /capturedir:<ДИСК С ВИНДОЙ>:\ /name:windows
```
9. Выключаем виртуалку.

На выходе мы на нашем USB устройстве получаем install.wim файл. Нам его нужно засунуть в распакованный образ винды (предварительно удалив из него install.esd), после чего открываем утилиту "Deployment tools". В нем пишем следующее:
 
 ```
 Oscdimg /u2 /m /bootdata:2#p0,e,bD:\win10cus\boot\Etfsboot.com#pef,e,bD:\win10cus\efi\microsoft\boot\Efisys.bin D:\win10cus D:\WindowsCustom.iso
 ```

Собственно, после этого останется только дождаться окончания процесса, и наш образ windows будет готов к установке!


(Если у вас остался образ в DISM, и он не дает продолжить процесс, то пишем: ```dism /Cleanup-Wim```